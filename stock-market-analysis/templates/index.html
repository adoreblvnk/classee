{% extends "base.html" %} {% block content %}
<div class="container mx-auto p-4">
  <h1 class="text-3xl font-bold text-center mb-8">Stock Market Analysis</h1>

  <div class="space-y-6">
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/lightpick@1.6.2/css/lightpick.css"
    />

    <!-- SMA Return Card -->
    <div class="bg-white shadow-md rounded-lg p-6">
      <h2 class="text-xl font-semibold mb-4">Date Range Selector for SMA</h2>

      <!-- Corrected Window Size Form -->
      <form method="get" class="mb-4">
        <div class="flex items-end gap-4">
          <!-- Date Range Selector -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Range Selector</label
            >
            <div class="flex items-center gap-2">
              <input
                type="text"
                id="date_from"
                name="date_range_start"
                class="border rounded px-2 py-1 w-28 form-control form-control-sm"
              />
              <span>to</span>
              <input
                type="text"
                id="date_to"
                name="date_range_end"
                class="border rounded px-2 py-1 w-28 form-control form-control-sm"
              />
            </div>
          </div>

          <!-- Window Period Selector -->
          <div>
            <label
              for="sma_window_size"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Window Period of SMA</label
            >
            <input
              type="number"
              min="2"
              value="2"
              id="sma_window_size"
              name="sma_window_size"
              class="border rounded px-2 py-1 w-24 form-control form-control-sm"
            />
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
          >
            Update
          </button>
        </div>
      </form>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/lightpick@1.6.2/lightpick.min.js"></script>
      <script>
        var picker = new Lightpick({
          field: document.getElementById("date_from"),
          secondField: document.getElementById("date_to"),
          singleDate: false,
          minDate: moment("2010-06-29"),
          maxDate: moment("2022-03-24"),
          onSelect: function (start, end) {
            var date1 = "";
            var date2 = "";
            date1 += start ? start.format("DD-MM-YYYY") : null;
            date2 += end ? end.format("DD-MM-YYYY") : null;
          },
        });
      </script>
      <h2 class="text-xl font-semibold mb-4">SMA Return</h2>
      <div class="img-div">
        {% if sma_return['img'] %}
            <img src="{{ url_for('chart', path=sma_return['img']) }}" alt="SMA chart" />
        {% else %}
            <p class="text-red-600">
                {{ sma_return.get('error') }}
            </p>
        {% endif %}
      </div>
    </div>

    <!-- Up/Down Runs Card -->
    <div class="bg-white shadow-md rounded-lg p-6">
      <h2 class="text-xl font-semibold mb-4">Up/Down Runs</h2>
      <div>
        <div class="mb-2">
          <p class="text-gray-600">Longest Up:</p>
          <p class="text-green-500">
            {{ up_down_runs.longest_up.length }} days ({{
            up_down_runs.longest_up.start_date }} → {{
            up_down_runs.longest_up.end_date }})
          </p>
        </div>
        <div>
          <p class="text-gray-600">Longest Down:</p>
          <p class="text-red-500">
            {{ up_down_runs.longest_down.length }} days ({{
            up_down_runs.longest_down.start_date }} → {{
            up_down_runs.longest_down.end_date }})
          </p>
        </div>
        <div class="mb-2">
          <p class="text-gray-600">Median Up Run Length:</p>
          <p class="text-blue-500">
            {{ up_down_runs.median_up_run_length }} days
          </p>
        </div>
        <div class="mb-2">
          <p class="text-gray-600">Median Down Run Length:</p>
          <p class="text-blue-500">
            {{ up_down_runs.median_down_run_length }} days
          </p>
        </div>
        <div class="mb-2">
          <p class="text-gray-600">Total Runs:</p>
          <p class="text-gray-700">
            {{ up_down_runs.total_upward_runs }} upward, {{
            up_down_runs.total_downward_runs }} downward
          </p>
        </div>
      </div>
    </div>

    <!-- Daily Return Card -->
    <div class="bg-white shadow-md rounded-lg p-6">
      <h2 class="text-xl font-semibold mb-4">Daily Return</h2>

      <!-- Bar Chart Container -->
      <div class="mt-6 mb-4 h-64 relative">
        <canvas id="dailyReturnChart"></canvas>
      </div>

      <div>
        <div class="mb-2">
          <p class="text-gray-600">Stats for daily return:</p>
          <p class="text-black">
            Mean Return (%): {{ daily_return.mean }}%,<br />
            Std Deviation (%): {{ daily_return.std }}%,<br />
            Max Loss (%): {{ daily_return.min }}%,<br />
            Max Gain (%): {{ daily_return.max }}%,<br />
            Positive Days: {{ daily_return.post_day }} days,<br />
            Neutral Days: {{ daily_return.neutral_day }} days,<br />
            Negative Days: {{ daily_return.neg_day }} days,<br />
            Total return Days: {{ daily_return.total_return_days }} days,<br />
            Win Rate (%): {{ daily_return.win_rate }}%<br />
          </p>
        </div>
      </div>
    </div>

    <!-- Max Profit Card -->
    <div class="bg-white shadow-md rounded-lg p-6">
      <h2 class="text-xl font-semibold mb-4">Maximum Profit</h2>

      <!-- Window Size Form -->
      <form method="get" class="mb-4">
        <div class="flex items-center gap-2">
          <label for="window_size" class="text-gray-700">Window Size:</label>
          <input
            type="number"
            id="window_size"
            name="window_size"
            min="2"
            max="{{ max_profit.max_window_size }}"
            value="{{ max_profit.current_window_size }}"
            class="border rounded px-2 py-1 w-24"
          />
          <button
            type="submit"
            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
          >
            Update
          </button>
        </div>
      </form>

      <!-- max prof chart -->
      <div class="relative h-96">
        <canvas id="maxProfChart"></canvas>
      </div>

      <!-- Display Max Profit Results -->
      <div class="mb-2">
        <p class="text-gray-600">
          Max Profit:
          <span class="text-blue-500">{{
            "%.2f"|format(max_profit.max_profit.max_profit)
          }}</span>
        </p>
        <p class="text-gray-600">
          Best Window Start Date:
          <span class="text-blue-500">{{
            max_profit.max_profit.best_window_start_date
          }}</span>
        </p>
        <p class="text-gray-600">
          Best Window End Date:
          <span class="text-blue-500">{{
            max_profit.max_profit.best_window_end_date
          }}</span>
        </p>
      </div>

      <!-- Explanation -->
      <div class="mt-6 border-t pt-4">
        <h3 class="text-lg font-semibold mb-2">Explanation for Max Profit</h3>
        <div class="prose max-w-none text-gray-800 space-y-3">
          <p>
            this section finds the most profitable period for trading based on a
            "window size" you provide. here's how to read the output:
          </p>

          <div>
            <h4 class="font-semibold">reading the chart:</h4>
            <ul class="list-disc list-inside ml-4">
              <li>
                the
                <span class="text-blue-500 font-semibold">blue line</span> shows
                the stock's closing price.
              </li>
              <li>
                <span class="text-green-500 font-semibold"
                  >green triangles (▲)</span
                >
                mark a "buy" day. this happens if the next day's price is
                higher.
              </li>
              <li>
                <span class="text-red-500 font-semibold"
                  >red triangles (▼)</span
                >
                mark a "sell" day, capturing the profit from the previous day's
                price increase.
              </li>
              <li>
                the chart is zoomed in to show only the single
                <span class="font-semibold">most profitable window</span> found
                in the entire dataset for the size you selected.
              </li>
            </ul>
          </div>

          <div>
            <h4 class="font-semibold">understanding the values:</h4>
            <ul class="list-disc list-inside ml-4">
              <li>
                <strong>window size:</strong> this is the number of trading days
                we analyze at a time. our code slides a window of this size
                across the entire stock history to find the best one.
              </li>
              <li>
                <strong>max profit:</strong> this is the total profit from all
                the buy (▲) and sell (▼) trades
                <span class="font-semibold">added together</span>, but only for
                the trades that occurred within the "best window" shown on the
                chart.
              </li>
              <li>
                <strong>best window dates:</strong> these are the start and end
                dates of that single most profitable period.
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Max Profit Chart
    const ctx = document.getElementById("maxProfChart").getContext("2d");

    // full dataset
    const allDates = {{ all_dates|tojson }};
    const allPrices = {{ all_prices|tojson }};

    // data specific to the selected window
    const buyPoints = {{ max_profit.max_profit.buy_points|tojson }};
    const sellPoints = {{ max_profit.max_profit.sell_points|tojson }};
    const bestWindowStartDate =
      "{{ max_profit.max_profit.best_window_start_date }}";
    const bestWindowEndDate =
      "{{ max_profit.max_profit.best_window_end_date }}";

    // default to full dataset
    let chartDates = allDates;
    let chartPrices = allPrices;

    // if a specific window is selected, filter data for the chart
    if (bestWindowStartDate && bestWindowEndDate) {
      const startIndex = allDates.indexOf(bestWindowStartDate);
      const endIndex = allDates.indexOf(bestWindowEndDate);

      if (startIndex !== -1 && endIndex !== -1) {
        // slice data to match the window for the main price line
        chartDates = allDates.slice(startIndex, endIndex + 1);
        chartPrices = allPrices.slice(startIndex, endIndex + 1);
      }
    }

    new Chart(ctx, {
      type: "line",
      data: {
        labels: chartDates,
        datasets: [
          {
            label: "Closing Price",
            data: chartPrices,
            borderColor: "rgba(54, 162, 235, 0.5)",
            borderWidth: 2,
            pointRadius: 0, // hide points on the main line
            tension: 0.1,
          },
          {
            type: "scatter",
            label: "Buy",
            data: buyPoints,
            backgroundColor: "green",
            pointStyle: "triangle",
            radius: 8,
          },
          {
            type: "scatter",
            label: "Sell",
            data: sellPoints,
            backgroundColor: "red",
            pointStyle: "triangle",
            rotation: 180,
            radius: 8,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: {
              maxTicksLimit: 10, // prevent cluttered labels on x-axis
            },
          },
          y: {
            beginAtZero: false,
            ticks: {
              callback: function (value) {
                return "$" + value.toFixed(2);
              },
            },
          },
        },
        plugins: {
          tooltip: {
            mode: "index",
            intersect: false,
          },
          legend: {
            position: "top",
          },
        },
      },
    });

    // Daily Return Chart
    const dailyReturnCtx = document
      .getElementById("dailyReturnChart")
      .getContext("2d");

    // Convert the DataFrame to a JSON-serializable format
    const returns = {{daily_return.daily_return|tojson}};
    const returnDates = {{all_dates|tojson}}.slice(1);
    // Extract dates and returns

    // Create background colors based on positive/negative values
    const backgroundColors = returns.map((value) =>
      value >= 0 ? "rgba(75, 192, 192, 0.7)" : "rgba(255, 99, 132, 0.7)"
    );

    // Create border colors based on positive/negative values
    const borderColors = returns.map((value) =>
      value >= 0 ? "rgba(75, 192, 192, 1)" : "rgba(255, 99, 132, 1)"
    );

    new Chart(dailyReturnCtx, {
      type: "bar",
      data: {
        labels: returnDates,
        datasets: [
          {
            label: "Daily Return (%)",
            data: returns,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: "Return (%)",
            },
            grid: {
              color: "rgba(0, 0, 0, 0.1)",
            },
          },
          x: {
            title: {
              display: true,
              text: "Date",
            },
            grid: {
              display: true,
            },
            ticks: {
              maxTicksLimit: 12, // Limit number of x-axis labels to prevent clutter
            },
          },
        },
        plugins: {
          legend: {
            display: true,
            position: "top",
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                return `Return: ${context.raw}%`;
              },
            },
          },
        },
      },
    });
  });
</script>
{% endblock %}